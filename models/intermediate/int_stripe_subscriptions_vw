{{ config(materialized='view') }}

WITH unioned_subs AS (
    SELECT * FROM {{ ref('stg_stripe_subscriptions_vw') }}
    UNION ALL
    SELECT * FROM {{ ref('stg_stripe_subscriptions_token_vw') }}
),
-- Add CTEs for all required tables/logic, using the provided business logic as a guide
SUBS AS (
    SELECT * FROM unioned_subs
),
PRODUCT_DETAILS AS (
    -- You may need to adjust this join logic to match your actual product/price model
    SELECT * FROM {{ ref('stg_reference_product_price_vw') }}
),
-- Add other CTEs for FIRST_PRICE_ID, ORIGINAL_PRODUCT_DETAILS, INVOICE_COUNT, FIRST_INVOICE, COUPONS_IMPACTING_NEXT_INVOICE, PLANS_FIRST_WASH, PLANS_LAST_WASH, HIERARCHY as needed

-- Main SELECT implementing the provided business logic
SELECT
    SI.TENANT__R__EXTERNAL_ID__C AS TENANT_ID,
    SUBS.CUSTOMER_ID AS USER_ID,
    SUBS.EMAIL AS CUSTOMER_EMAIL,
    SUBS.CUSTOMER_NAME AS CUSTOMER_NAME,
    SUBS.PHONE_NUMBER AS CUSTOMER_PHONE_NUMBER,
    SI.SUBSCRIPTION_ID AS STRIPE_SUBSCRIPTION_ID,
    SI.SUBSCRIPTION_ITEM_ID AS STRIPE_SUBSCRIPTION_ITEM_ID,
    SUBS.PLAN_CREATED_DATE AS PLAN_CREATED_DATE,
    SUBS.PLAN_START_DATE AS PLAN_START_DATE,
    CASE
        WHEN PRODUCT_DETAILS.FLEET_STRATEGY = 'PayPerWash' THEN 'Fleet Pay Per Wash'
        WHEN PRODUCT_DETAILS.PLAN_TYPE = 'Fleet' THEN 'Fleet Unlimited Plan'
        WHEN SI.QUANTITY > 1 THEN 'Family Plan'
        ELSE 'Standard Plan'
    END AS PLAN_TYPE,
    PRODUCT_DETAILS.PLAN_NAME AS PLAN_NAME,
    IFNULL(ORIGINAL_PRODUCT_DETAILS.PLAN_NAME, PRODUCT_DETAILS.PLAN_NAME) AS ORIGINAL_PLAN_NAME,
    SI.QUANTITY AS PLAN_QUANTITY,
    PRODUCT_DETAILS.PRICE_GROUP AS PRICE_GROUP,
    CONCAT(PRODUCT_DETAILS.INTERVAL_COUNT, ' ', PRODUCT_DETAILS.INTERVAL_TYPE,
        CASE WHEN PRODUCT_DETAILS.INTERVAL_COUNT > 1 THEN 'S' ELSE '' END
    ) AS PLAN_TERM,
    -- CURRENT_PRICE_PRIOR_TO_DISCOUNTS logic here
    -- GROSS_MONTHLY_VALUE logic here
    -- CURRENT_PRICE_NET_OF_FIRST_COUPON logic here
    -- CURRENT_PRICE_NET_OF_COUPON logic here
    -- NET_MONTHLY_VALUE logic here
    -- MRR_ALL_PLANS logic here
    -- MRR logic here
    FIRST_INVOICE.SUBTOTAL - FIRST_INVOICE.DISCOUNT AS FIRST_INVOICE_AMOUNT,
    INVOICE_COUNT.NUMBER_OF_PAID_INVOICES_TO_DATE AS NUMBER_OF_PAID_INVOICES_TO_DATE,
    SUBS.STATUS AS STATUS,
    SUBS.NEW_STATUS AS NEW_STATUS,
    SUBS.CURRENT_PERIOD_END_DATE AS CURRENT_PERIOD_END_DATE,
    SUBS.CANCELATION_REQUESTED_DATE AS CANCELATION_REQUESTED_DATE,
    SUBS.CANCELATION_SCHEDULED_FOR_DATE AS CANCELATION_SCHEDULED_FOR_DATE,
    SUBS.PLAN_END_DATE AS PLAN_END_DATE,
    SUBS.CANCEL_AT_PERIOD_END AS IS_PLAN_CANCEL_AT_PERIOD_END,
    SUBS.CANCELATION_METHOD AS CANCELATION_METHOD,
    SUBS.CANCELATION_REASON_CODE AS CANCELATION_REASON_CODE,
    SUBS.CANCELATION_REASON_TEXT AS CANCELATION_REASON_TEXT,
    SUBS.CANCELATION_COMMENT AS CANCELATION_COMMENT,
    SUBS.CANCELED_BY AS CANCELED_BY,
    SUBS.FAILED_PAYMENT_REASON AS FAILED_PAYMENT_REASON,
    SUBS.FAILED_PAYMENT_CARD_TYPE AS FAILED_PAYMENT_CARD_TYPE,
    SUBS.CANCELATION_CREATE_DATE AS CANCELATION_CREATE_DATE,
    IFF(COUPONS_2.NAME IS NULL, COUPONS_1.NAME, CONCAT(COUPONS_1.NAME,'; ',COUPONS_2.NAME)) AS APPLIED_COUPON,
    SUBS.IS_PLAN_MIGRATED AS IS_PLAN_MIGRATED,
    SUBS.REACTIVATED_LICENSE_PLATE AS REACTIVATED_LICENSE_PLATE,
    SUBS.ATTENDANT AS ATTENDANT,
    SUBS.ATTENDANT_NAME AS ATTENDANT_NAME,
    SUBS.ASSIGNED_LOCATION AS ASSIGNED_LOCATION,
    IFNULL(SUBS.PLAN_SIGN_UP_LOCATION, PLANS_FIRST_WASH.FIRST_WASH_LOCATION) AS FIRST_KNOWN_AMP_LOCATION,
    SUBS.PLAN_SIGN_UP_LOCATION AS PLAN_SIGN_UP_LOCATION,
    SUBS.POS_LEGACY_LOCATION AS POS_LEGACY_LOCATION,
    PLANS_FIRST_WASH.FIRST_WASH_LOCATION AS FIRST_WASH_LOCATION,
    PLANS_LAST_WASH.LAST_WASH_LOCATION AS LAST_WASH_LOCATION,
    SUBS.PAUSE_REQUEST_DATE AS PAUSE_REQUEST_DATE,
    SUBS.PAUSE_EFFECTIVE_DATE AS PAUSE_EFFECTIVE_DATE,
    SUBS.PAUSE_END_DATE AS PAUSE_END_DATE,
    SUBS.PENDING_DOWNGRADE_DATE AS PENDING_DOWNGRADE_DATE,
    SUBS.PRE_DOWNGRADE_PLAN_NAME AS PRE_DOWNGRADE_PLAN_NAME,
    SUBS.AUTO_CANCEL_DATE AS AUTO_CANCEL_DATE,
    SUBS.LICENSE_PLATE_STATE AS LICENSE_PLATE_STATE,
    SUBS.LICENSE_PLATE_NUMBER AS LICENSE_PLATE_NUMBER,
    SUBS.RFID AS RFID,
    CASE
        WHEN SUBS.TENANT__R__EXTERNAL_ID__C = '2kds72w63tiujwdmqox8g2q0syvrdqz4' AND HIERARCHY.IS_FRANCHISE = TRUE THEN '2kds72w63tiujwdmqox8g2q0syvrdqz4_franchise'
        WHEN SUBS.TENANT__R__EXTERNAL_ID__C = '2kds72w63tiujwdmqox8g2q0syvrdqz4' THEN '2kds72w63tiujwdmqox8g2q0syvrdqz4_corporate'
        ELSE SUBS.TENANT__R__EXTERNAL_ID__C
    END AS ROW_LEVEL_SECURITY_ID
FROM REPORTING.STRIPE_SUBSCRIPTION_ITEMS SI
INNER JOIN SUBS ON SI.SUBSCRIPTION_ID = SUBS.SUBSCRIPTION_ID
INNER JOIN PRODUCT_DETAILS ON SI.PRICE_ID = PRODUCT_DETAILS.STRIPE_PRICE_ID
-- Add the rest of the joins for FIRST_PRICE_ID, ORIGINAL_PRODUCT_DETAILS, INVOICE_COUNT, FIRST_INVOICE, COUPONS_IMPACTING_NEXT_INVOICE, PLANS_FIRST_WASH, PLANS_LAST_WASH, HIERARCHY as needed
